<!doctype html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Task visualizer</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
</head>

<body>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div id="reader"></div>
        </div>
    </div>

    <div class="row py-2" style="height: 70vh;">
        <div class="col" id="map" style="height: 100%; width: 100%;"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
<script src="https://unpkg.com/htmx.org@2.0.8"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
    const formatsToSupport = [
        Html5QrcodeSupportedFormats.QR_CODE
    ];
    const html5QrcodeScanner = new Html5QrcodeScanner("reader", {
        fps: 10,
        qrbox: 250,
        formatsToSupport: formatsToSupport
    });
    html5QrcodeScanner.render(onScanSuccess);

    const map = L.map('map').setView([51.505, -0.09], 13);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    })
        .addTo(map);

    const markers = [];

    function onScanSuccess(decodedText, decodedResult) {
        const waypoints = parseQrCodeIntoWaypoints(decodedText);
        addWaypointsToTheMap(waypoints);
    }

    function parseQrCodeIntoWaypoints(decodedText) {
        const asJson = JSON.parse(decodedText.replaceAll("XCTSK:", ""));
        const unparsedWaypoints = asJson.t;
        const coordinates = parseCoordinates(unparsedWaypoints.map(waypoint => waypoint.z).join(""));
        return unparsedWaypoints.map((waypoint, index) => {
                return {...coordinates[index], name: waypoint.n}
            }
        );
    }

    function parseCoordinates(encoded) {
        function decode(initialIndex) {
            let index = initialIndex;
            let b;
            let result = 1;
            let shift = 0;

            let stopper = 0;

            do {
                b = encoded.charCodeAt(index++) - 63 - 1;
                result += b << shift;
                shift += 5;
                stopper += 1;
            } while (b >= 0x1f && stopper < 10);

            return {
                result: ((result & 1) !== 0) ? ~(result >> 1) : (result >> 1),
                index: index
            };
        }

        const len = encoded.length;

        let index = 0;

        const path = [];

        while (index < len) {
            const lonRet = decode(index);
            const lon = lonRet.result;
            index = lonRet.index;

            const latRet = decode(index);
            const lat = latRet.result;
            index = latRet.index;

            const altRet = decode(index);
            const altitude = altRet.result;
            index = altRet.index;

            const radRet = decode(index);
            const radius = radRet.result;
            index = radRet.index;

            path.push({lat: lat * 1e-5, lon: lon * 1e-5, altitude: altitude, radius: radius});
        }

        return path;
    }

    function addWaypointsToTheMap(waypoints) {
        for (let i = 0; i < markers.length; i++) {
            map.removeLayer(markers[i]);
        }

        const latlons = [];
        for (const wpt of waypoints) {
            const wptCircle = L.circle([wpt.lat, wpt.lon], {
                color: 'red',
                fillColor: '#f03',
                fillOpacity: 0.2,
                radius: wpt.radius
            }).addTo(map);
            wptCircle.bindPopup(wpt.name);
            markers.push(wptCircle);

            latlons.push([wpt.lat, wpt.lon]);
        }

        const polyline = L.polyline(latlons, {color: 'blue'}).addTo(map);
        markers.push(polyline);

        if (waypoints.length > 0) {
            const lats = latlons.map(e => e[0]);
            const lons = latlons.map(e => e[1]);

            map.fitBounds([
                [Math.max(...lats), Math.min(...lons)],
                [Math.min(...lats), Math.max(...lons)]
            ]);
        }
    }
</script>

</body>
</html>
