<!doctype html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Task visualizer</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar-v2@3.2.3/css/leaflet-sidebar.min.css"/>
    <style>
        body {
            padding: 0;
            margin: 0;
        }

        html, body, #map {
            height: 100%;
            font: 10pt "Helvetica Neue", Arial, Helvetica, sans-serif;
        }
    </style>
</head>

<body>

<div id="sidebar" class="leaflet-sidebar collapsed">

    <div class="leaflet-sidebar-tabs">
        <ul role="tablist">
            <li><a href="#qr" role="tab"><i class="fa fa-qrcode active"></i></a></li>
        </ul>
    </div>

    <div class="leaflet-sidebar-content">
        <div class="leaflet-sidebar-pane" id="qr">
            <h1 class="leaflet-sidebar-header">
                Scan QR code
                <span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span>
            </h1>

            <div id="reader" style="margin-top: 20px;"></div>
        </div>

    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
<script src="https://unpkg.com/leaflet-sidebar-v2@3.2.3/js/leaflet-sidebar.min.js"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
    const formatsToSupport = [
        Html5QrcodeSupportedFormats.QR_CODE
    ];
    const html5QrcodeScanner = new Html5QrcodeScanner("reader", {
        fps: 10,
        qrbox: 250,
        formatsToSupport: formatsToSupport
    });
    html5QrcodeScanner.render(onScanSuccess);

    const map = L.map('map').setView([51.505, -0.09], 13);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    })
        .addTo(map);

    const sidebar = L.control.sidebar({container: 'sidebar'})
        .addTo(map)
        .open('qr');

    const markers = [];

    function onScanSuccess(decodedText, decodedResult) {
        const waypoints = parseQrCodeIntoWaypoints(decodedText);
        addWaypointsToTheMap(waypoints);
    }

    function parseQrCodeIntoWaypoints(decodedText) {
        const asJson = JSON.parse(decodedText.replaceAll("XCTSK:", ""));
        const unparsedWaypoints = asJson.t;
        const coordinates = parseCoordinates(unparsedWaypoints.map(waypoint => waypoint.z).join(""));
        return unparsedWaypoints.map((waypoint, index) => {
                return {...coordinates[index], name: waypoint.n}
            }
        );
    }

    function parseCoordinates(encoded) {
        function decode(initialIndex) {
            let index = initialIndex;
            let b;
            let result = 1;
            let shift = 0;

            let stopper = 0;

            do {
                b = encoded.charCodeAt(index++) - 63 - 1;
                result += b << shift;
                shift += 5;
                stopper += 1;
            } while (b >= 0x1f && stopper < 10);

            return {
                result: ((result & 1) !== 0) ? ~(result >> 1) : (result >> 1),
                index: index
            };
        }

        const len = encoded.length;

        let index = 0;

        const path = [];

        while (index < len) {
            const lonRet = decode(index);
            const lon = lonRet.result;
            index = lonRet.index;

            const latRet = decode(index);
            const lat = latRet.result;
            index = latRet.index;

            const altRet = decode(index);
            const altitude = altRet.result;
            index = altRet.index;

            const radRet = decode(index);
            const radius = radRet.result;
            index = radRet.index;

            path.push({lat: lat * 1e-5, lon: lon * 1e-5, altitude: altitude, radius: radius});
        }

        return path;
    }

    function addWaypointsToTheMap(waypoints) {
        for (let i = 0; i < markers.length; i++) {
            map.removeLayer(markers[i]);
        }

        const latlons = [];
        for (const wpt of waypoints) {
            const wptCircle = L.circle([wpt.lat, wpt.lon], {
                color: 'red',
                fillColor: '#f03',
                fillOpacity: 0.2,
                radius: wpt.radius
            }).addTo(map);
            wptCircle.bindPopup(wpt.name);
            markers.push(wptCircle);

            latlons.push([wpt.lat, wpt.lon]);
        }

        const polyline = L.polyline(latlons, {color: 'blue'}).addTo(map);
        markers.push(polyline);

        if (waypoints.length > 0) {
            const lats = latlons.map(e => e[0]);
            const lons = latlons.map(e => e[1]);

            map.fitBounds([
                [Math.max(...lats), Math.min(...lons)],
                [Math.min(...lats), Math.max(...lons)]
            ]);
        }
    }
</script>

</body>
</html>
